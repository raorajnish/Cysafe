{% extends 'base.html' %}
{% load static %}

{% block title %}Crime Management - Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .severity-critical { background-color: #dc3545; color: white; }
    .severity-high { background-color: #fd7e14; color: white; }
    .severity-medium { background-color: #ffc107; color: black; }
    .severity-low { background-color: #28a745; color: white; }
    
    .stats-card {
        transition: transform 0.2s ease-in-out;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    
    .crime-row {
        transition: background-color 0.2s ease;
    }
    .crime-row:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-content">
    <div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-shield-alt text-primary me-3"></i>
                        Cyber Crime Management
                    </h2>
                    <p class="text-muted mb-0">Manage and monitor cybersecurity threats and incidents</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCrimeModal">
                    <i class="fas fa-plus me-2"></i>Add New Crime
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-primary bg-opacity-10">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-primary mb-2"></i>
                    <h4 class="mb-1">{{ total_crimes }}</h4>
                    <p class="text-muted mb-0">Total Crimes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-danger bg-opacity-10">
                <div class="card-body text-center">
                    <i class="fas fa-fire fa-2x text-danger mb-2"></i>
                    <h4 class="mb-1">{{ critical_count }}</h4>
                    <p class="text-muted mb-0">Critical Threats</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-warning bg-opacity-10">
                <div class="card-body text-center">
                    <i class="fas fa-eye fa-2x text-warning mb-2"></i>
                    <h4 class="mb-1">{{ total_views }}</h4>
                    <p class="text-muted mb-0">Total Views</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 bg-success bg-opacity-10">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                    <h4 class="mb-1">{{ avg_severity }}</h4>
                    <p class="text-muted mb-0">Avg Severity</p>
                </div>
            </div>
        </div>
    </div>

        <!-- Sort Section -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label class="form-label fw-semibold mb-2">
                        <i class="fas fa-sort me-2"></i>Sort By
                    </label>
                    <select class="form-select" id="sortBy" onchange="sortCrimes()">
                        <option value="created_at">Date Created (Newest)</option>
                        <option value="created_at_old">Date Created (Oldest)</option>
                        <option value="type">Crime Type (A-Z)</option>
                        <option value="type_desc">Crime Type (Z-A)</option>
                        <option value="severity">Severity (High to Low)</option>
                        <option value="severity_low">Severity (Low to High)</option>
                        <option value="views">Most Viewed</option>
                        <option value="views_least">Least Viewed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold mb-2">
                        <i class="fas fa-list me-2"></i>Show
                    </label>
                    <select class="form-select" id="showCount" onchange="sortCrimes()">
                        <option value="all">All Crimes</option>
                        <option value="5">Top 5</option>
                        <option value="10">Top 10</option>
                        <option value="15">Top 15</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="resetSort()">
                            <i class="fas fa-undo me-1"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crimes Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Cyber Crimes List
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0">Crime Type</th>
                            <th class="border-0">Category</th>
                            <th class="border-0">Severity</th>
                            <th class="border-0">Views</th>
                            <th class="border-0">Created</th>
                            <th class="border-0 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for crime in crimes %}
                        <tr class="crime-row" data-search="{{ crime.type|lower }} {{ crime.description|lower }}" 
                            data-category="{{ crime.category }}" data-severity="{{ crime.severity }}" 
                            data-crime-id="{{ crime.id }}">
                            <td class="align-middle">
                                <div class="fw-semibold">{{ crime.type }}</div>
                                <small class="text-muted">{{ crime.description|truncatechars:50 }}</small>
                            </td>
                            <td class="align-middle">
                                <span class="badge bg-light text-dark">{{ crime.get_category_display }}</span>
                            </td>
                            <td class="align-middle">
                                <span class="badge severity-{{ crime.severity|lower }}">{{ crime.severity }}</span>
                            </td>
                            <td class="align-middle">
                                <i class="fas fa-eye text-primary me-1"></i>{{ crime.learn_more_clicks }}
                            </td>
                            <td class="align-middle">
                                <small class="text-muted">{{ crime.created_at|date:"M d, Y" }}</small>
                            </td>
                            <td class="align-middle text-center">
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" 
                                            onclick="console.log('View clicked'); viewCrime('{{ crime.id }}')" 
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="console.log('Edit clicked'); editCrime('{{ crime.id }}')" 
                                            title="Edit Crime">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" 
                                            onclick="console.log('Delete clicked'); deleteCrime('{{ crime.id }}')" 
                                            title="Delete Crime">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <h5>No crimes found</h5>
                                    <p>Start by adding your first cyber crime entry</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Hidden CSRF Token -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" id="csrfToken">

<!-- Add/Edit Crime Modal -->
<div class="modal fade" id="addCrimeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle fa-lg me-3"></i>Add New Cyber Crime
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCrimeForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Crime Type *</label>
                            <input type="text" class="form-control" id="type" name="type" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="EMAIL_FRAUD">Email Fraud</option>
                                <option value="FINANCIAL_FRAUD">Financial Fraud</option>
                                <option value="HARASSMENT">Harassment</option>
                                <option value="PERSONAL_DATA_BREACH">Personal Data Breach</option>
                                <option value="MALWARE">Malware</option>
                                <option value="PHISHING">Phishing</option>
                                <option value="SOCIAL_ENGINEERING">Social Engineering</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description *</label>
                            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Security Level *</label>
                            <select class="form-select" id="severity" name="severity" required>
                                <option value="">Select Severity</option>
                                <option value="CRITICAL">ðŸ”´ Critical</option>
                                <option value="HIGH">ðŸŸ  High</option>
                                <option value="MEDIUM">ðŸŸ¡ Medium</option>
                                <option value="LOW">ðŸŸ¢ Low</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Prevention Tips Section -->
                    <div class="mt-4">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="fas fa-shield-alt me-2"></i>Prevention Tips
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Prevention Tip 1</label>
                                <input type="text" class="form-control" name="prevention_tip_1" 
                                       placeholder="Enter prevention tip 1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Prevention Tip 2</label>
                                <input type="text" class="form-control" name="prevention_tip_2" 
                                       placeholder="Enter prevention tip 2">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Prevention Tip 3</label>
                                <input type="text" class="form-control" name="prevention_tip_3" 
                                       placeholder="Enter prevention tip 3">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Prevention Tip 4</label>
                                <input type="text" class="form-control" name="prevention_tip_4" 
                                       placeholder="Enter prevention tip 4">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reporting Steps Section -->
                    <div class="mt-4">
                        <h6 class="fw-bold text-info mb-3">
                            <i class="fas fa-flag me-2"></i>Reporting Steps
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Reporting Step 1</label>
                                <input type="text" class="form-control" name="reporting_step_1" 
                                       placeholder="Enter reporting step 1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Reporting Step 2</label>
                                <input type="text" class="form-control" name="reporting_step_2" 
                                       placeholder="Enter reporting step 2">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Reporting Step 3</label>
                                <input type="text" class="form-control" name="reporting_step_3" 
                                       placeholder="Enter reporting step 3">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Reporting Step 4</label>
                                <input type="text" class="form-control" name="reporting_step_4" 
                                       placeholder="Enter reporting step 4">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" name="add_crime">
                        <i class="fas fa-save me-2"></i>Add Crime
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Crime Modal -->
<div class="modal fade" id="viewCrimeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewCrimeTitle">
                    <i class="fas fa-eye fa-lg me-3"></i>Crime Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewCrimeContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editCrimeBtn">
                    <i class="fas fa-edit me-2"></i>Edit Crime
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCrimeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle fa-lg me-3"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this cyber crime? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="delete_id" id="deleteCrimeId">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Crime
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// Global Functions - Defined outside DOMContentLoaded for onclick access

function viewCrime(crimeId) {
    try {
        console.log('Viewing crime:', crimeId);
        
        // Check if modal element exists
        const modalElement = document.getElementById('viewCrimeModal');
        if (!modalElement) {
            console.error('View modal element not found!');
            alert('View modal not found!');
            return;
        }
        
        // Show loading state
        document.getElementById('viewCrimeTitle').textContent = 'Loading...';
        document.getElementById('viewCrimeContent').innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                <p class="text-muted">Loading crime details...</p>
            </div>
        `;
        
        // Fetch crime data from server
        fetch(`/admin/crimes/${crimeId}/data/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.getElementById('csrfToken').value,
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                
                // Update modal title
                document.getElementById('viewCrimeTitle').textContent = data.type;
                
                // Generate prevention tips HTML
                const preventionTipsHTML = data.prevention_tips && data.prevention_tips.length > 0 
                    ? data.prevention_tips.map(tip => `
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            ${tip}
                        </li>
                    `).join('')
                    : '<li class="text-muted"><em>No prevention tips available</em></li>';
                
                // Generate reporting steps HTML
                const reportingStepsHTML = data.reporting_steps && data.reporting_steps.length > 0
                    ? data.reporting_steps.map(step => `
                        <li class="mb-2">
                            <i class="fas fa-arrow-right text-info me-2"></i>
                            ${step}
                        </li>
                    `).join('')
                    : '<li class="text-muted"><em>No reporting steps available</em></li>';
                
                // Update modal content
                document.getElementById('viewCrimeContent').innerHTML = `
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-primary mb-3">
                                        <i class="fas fa-info-circle me-2"></i>Basic Information
                                    </h6>
                                    <div class="mb-3">
                                        <label class="fw-semibold text-muted">Category:</label>
                                        <div class="mt-1">${data.category}</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-semibold text-muted">Severity Level:</label>
                                        <div class="mt-1">
                                            <span class="badge severity-${data.severity.toLowerCase()}">${data.severity}</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-semibold text-muted">Total Views:</label>
                                        <div class="mt-1">
                                            <i class="fas fa-eye text-primary me-1"></i>${data.learn_more_clicks}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-semibold text-muted">Added Date:</label>
                                        <div class="mt-1">
                                            <i class="fas fa-calendar text-info me-1"></i>${new Date(data.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-primary mb-3">
                                        <i class="fas fa-align-left me-2"></i>Description
                                    </h6>
                                    <p class="text-muted">${data.description}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-4 mt-3">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="fas fa-shield-alt me-2"></i>Prevention Tips
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        ${preventionTipsHTML}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-info mb-3">
                                        <i class="fas fa-flag me-2"></i>Reporting Steps
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        ${reportingStepsHTML}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
                // Set up edit button
                document.getElementById('editCrimeBtn').onclick = function() {
                    modal.hide();
                    setTimeout(() => {
                        editCrime(crimeId);
                    }, 300);
                };
                
            })
            .catch(error => {
                console.error('Error fetching crime data:', error);
                document.getElementById('viewCrimeContent').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                        <p class="text-danger">Error loading crime details. Please try again.</p>
                    </div>
                `;
            });
    } catch (error) {
        console.error('Error in viewCrime:', error);
        alert('Error viewing crime: ' + error.message);
    }
}

function editCrime(crimeId) {
    try {
        console.log('Editing crime:', crimeId);
        
        // Check if modal element exists
        const modalElement = document.getElementById('addCrimeModal');
        if (!modalElement) {
            console.error('Edit modal element not found!');
            alert('Edit modal not found!');
            return;
        }
        
        // Fetch crime data from server
        fetch(`/admin/crimes/${crimeId}/data/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.getElementById('csrfToken').value,
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                console.log('Edit data received:', data);
                
                // Update modal title and button
                document.querySelector('#addCrimeModal .modal-title').innerHTML = `
                    <i class="fas fa-edit fa-lg me-3"></i>Edit Cyber Crime
                `;
                document.querySelector('#addCrimeModal button[type="submit"]').innerHTML = `
                    <i class="fas fa-save me-2"></i>Update Crime
                `;
                document.querySelector('#addCrimeModal button[type="submit"]').name = 'update_crime';
                
                // Add hidden crime ID field
                let crimeIdField = document.getElementById('crime_id');
                if (!crimeIdField) {
                    crimeIdField = document.createElement('input');
                    crimeIdField.type = 'hidden';
                    crimeIdField.id = 'crime_id';
                    crimeIdField.name = 'crime_id';
                    document.getElementById('addCrimeForm').appendChild(crimeIdField);
                }
                crimeIdField.value = crimeId;
                
                // Populate form fields
                document.getElementById('type').value = data.type;
                document.getElementById('category').value = data.category;
                document.getElementById('description').value = data.description;
                document.getElementById('severity').value = data.severity;
                
                // Populate prevention tips
                document.querySelector('input[name="prevention_tip_1"]').value = data.prevention_tips[0] || '';
                document.querySelector('input[name="prevention_tip_2"]').value = data.prevention_tips[1] || '';
                document.querySelector('input[name="prevention_tip_3"]').value = data.prevention_tips[2] || '';
                document.querySelector('input[name="prevention_tip_4"]').value = data.prevention_tips[3] || '';
                
                // Populate reporting steps
                document.querySelector('input[name="reporting_step_1"]').value = data.reporting_steps[0] || '';
                document.querySelector('input[name="reporting_step_2"]').value = data.reporting_steps[1] || '';
                document.querySelector('input[name="reporting_step_3"]').value = data.reporting_steps[2] || '';
                document.querySelector('input[name="reporting_step_4"]').value = data.reporting_steps[3] || '';
                
                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
            })
            .catch(error => {
                console.error('Error fetching crime data for edit:', error);
                alert('Error loading crime data for editing: ' + error.message);
            });
    } catch (error) {
        console.error('Error in editCrime:', error);
        alert('Error editing crime: ' + error.message);
    }
}

function deleteCrime(crimeId) {
    try {
        console.log('Deleting crime:', crimeId);
        const deleteInput = document.getElementById('deleteCrimeId');
        if (deleteInput) {
            deleteInput.value = crimeId;
        }
        const modalElement = document.getElementById('deleteCrimeModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    } catch (error) {
        console.error('Error in deleteCrime:', error);
        alert('Error deleting crime: ' + error.message);
    }
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

function addFormField(containerId, fieldName, placeholder) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error('Container not found:', containerId);
        return;
    }
    
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'input-group mb-3';
    
    const isPrevention = containerId === 'preventionTipsContainer';
    const iconClass = isPrevention ? 'fas fa-check' : 'fas fa-flag';
    const bgClass = isPrevention ? 'bg-success bg-opacity-10 text-success' : 'bg-info bg-opacity-10 text-info';
    const btnClass = isPrevention ? 'btn-outline-success' : 'btn-outline-info';
    
    fieldDiv.innerHTML = `
        <span class="input-group-text ${bgClass}">
            <i class="${iconClass}"></i>
        </span>
        <input type="text" class="form-control" name="${fieldName}" placeholder="${placeholder}">
        <button class="btn ${btnClass}" type="button" onclick="removeFormField(this)">
            <i class="fas fa-minus"></i>
        </button>
    `;
    
    container.appendChild(fieldDiv);
    
    // Focus on the new input field
    const newInput = fieldDiv.querySelector('input');
    if (newInput) {
        newInput.focus();
        
        // Debug: Log the new field
        console.log(`Added new field: ${fieldName} with value: "${newInput.value}"`);
    }
    
    // Show notification
    const action = isPrevention ? 'prevention tip' : 'reporting step';
    showNotification(`Added new ${action} field`, 'success');
    
    // Debug: Count total fields after adding
    const totalFields = document.querySelectorAll(`input[name="${fieldName}"]`).length;
    console.log(`Total ${fieldName} fields now: ${totalFields}`);
}

function removeFormField(button) {
    const fieldGroup = button.closest('.input-group');
    if (fieldGroup) {
        // Add fade out animation
        fieldGroup.style.transition = 'opacity 0.3s ease';
        fieldGroup.style.opacity = '0';
        
        setTimeout(() => {
            fieldGroup.remove();
            showNotification('Field removed successfully', 'info');
        }, 300);
    }
}

function sortCrimes() {
    const sortBy = document.getElementById('sortBy').value;
    const showCount = document.getElementById('showCount').value;
    const tbody = document.querySelector('tbody');
    const crimeRows = Array.from(document.querySelectorAll('.crime-row'));
    
    if (crimeRows.length === 0) return;
    
    // Sort the rows based on the selected criteria
    crimeRows.sort((a, b) => {
        switch (sortBy) {
            case 'created_at':
                // Sort by date (newest first) - assuming date is in the 5th column
                const dateA = a.cells[4].textContent.trim();
                const dateB = b.cells[4].textContent.trim();
                return new Date(dateB) - new Date(dateA);
            
            case 'created_at_old':
                // Sort by date (oldest first)
                const dateAOld = a.cells[4].textContent.trim();
                const dateBOld = b.cells[4].textContent.trim();
                return new Date(dateAOld) - new Date(dateBOld);
            
            case 'type':
                // Sort by crime type (A-Z)
                const typeA = a.cells[0].textContent.trim();
                const typeB = b.cells[0].textContent.trim();
                return typeA.localeCompare(typeB);
            
            case 'type_desc':
                // Sort by crime type (Z-A)
                const typeADesc = a.cells[0].textContent.trim();
                const typeBDesc = b.cells[0].textContent.trim();
                return typeBDesc.localeCompare(typeADesc);
            
            case 'severity':
                // Sort by severity (High to Low)
                const severityOrder = { 'CRITICAL': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
                const severityA = a.cells[2].textContent.trim();
                const severityB = b.cells[2].textContent.trim();
                return severityOrder[severityB] - severityOrder[severityA];
            
            case 'severity_low':
                // Sort by severity (Low to High)
                const severityOrderLow = { 'CRITICAL': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
                const severityALow = a.cells[2].textContent.trim();
                const severityBLow = b.cells[2].textContent.trim();
                return severityOrderLow[severityALow] - severityOrderLow[severityBLow];
            
            case 'views':
                // Sort by views (most viewed first)
                const viewsA = parseInt(a.cells[3].textContent.match(/\d+/)[0]) || 0;
                const viewsB = parseInt(b.cells[3].textContent.match(/\d+/)[0]) || 0;
                return viewsB - viewsA;
            
            case 'views_least':
                // Sort by views (least viewed first)
                const viewsALeast = parseInt(a.cells[3].textContent.match(/\d+/)[0]) || 0;
                const viewsBLeast = parseInt(b.cells[3].textContent.match(/\d+/)[0]) || 0;
                return viewsALeast - viewsBLeast;
            
            default:
                return 0;
        }
    });
    
    // Clear the tbody
    tbody.innerHTML = '';
    
    // Add sorted rows back
    let addedCount = 0;
    crimeRows.forEach((row, index) => {
        if (showCount === 'all' || addedCount < parseInt(showCount)) {
            tbody.appendChild(row);
            addedCount++;
            
            // Add fade-in animation
            row.style.opacity = '0';
            row.style.transform = 'translateY(10px)';
            setTimeout(() => {
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '1';
                row.style.transform = 'translateY(0)';
            }, index * 50);
        }
    });
    
    showNotification(`Sorted by ${document.getElementById('sortBy').options[document.getElementById('sortBy').selectedIndex].text}`, 'success');
}

function resetSort() {
    // Reset dropdowns
    document.getElementById('sortBy').value = 'created_at';
    document.getElementById('showCount').value = 'all';
    
    // Reload the page to reset the order
    location.reload();
}

function clearFilters() {
    // This function is kept for compatibility but now calls resetSort
    resetSort();
}

// Modal reset function
function resetCrimeModal() {
    const form = document.getElementById('addCrimeForm');
    if (form) {
        form.reset();
        
        // Reset modal title and button
        document.querySelector('#addCrimeModal .modal-title').innerHTML = `
            <i class="fas fa-plus-circle fa-lg me-3"></i>Add New Cyber Crime
        `;
        document.querySelector('#addCrimeModal button[type="submit"]').innerHTML = `
            <i class="fas fa-save me-2"></i>Add Crime
        `;
        document.querySelector('#addCrimeModal button[type="submit"]').name = 'add_crime';
        
        // Remove crime_id field if it exists
        const crimeIdField = document.getElementById('crime_id');
        if (crimeIdField) {
            crimeIdField.remove();
        }
    }
}

// Add event listener for modal close
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing crime management...');
    
    // Initialize sort functionality
    console.log('Sort functionality initialized');
    
    // Simple form submission handler
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('addCrimeForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('=== FORM SUBMISSION STARTED ===');
                
                // Log all form data before submission
                const formData = new FormData(this);
                console.log('Form data being submitted:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                console.log('=== FORM SUBMISSION COMPLETE ===');
            });
        }
    });

    // Reset modal when closed
    const addCrimeModal = document.getElementById('addCrimeModal');
    if (addCrimeModal) {
        addCrimeModal.addEventListener('hidden.bs.modal', function() {
            resetCrimeModal();
        });
    }
    
    // Initialize any Bootstrap components
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add click handlers to table rows
    const crimeRows = document.querySelectorAll('.crime-row');
    crimeRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't trigger if clicking on action buttons
            if (e.target.closest('.btn-group')) {
                return;
            }
            
            // Get the crime ID from the first action button
            const viewBtn = this.querySelector('button[onclick*="viewCrime"]');
            if (viewBtn) {
                const crimeId = viewBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
                viewCrime(crimeId);
            }
        });
    });
});
</script>
{% endblock %} 